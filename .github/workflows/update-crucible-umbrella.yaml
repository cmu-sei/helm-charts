name: Update Crucible Umbrella Chart

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  update-charts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq

      - name: Add Helm repositories
        run: |
          helm repo add cemusei https://helm.cmusei.dev/charts
          helm repo update

      - name: Run update script
        id: update
        run: |
          .github/scripts/update-crucible-umbrella.sh

          # Check if there were any changes
          if git diff --quiet charts/crucible/Chart.yaml charts/crucible/Chart.lock; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Increment chart version
        if: steps.update.outputs.has_changes == 'true'
        id: version
        run: |
          cd charts/crucible

          # Get current version
          CURRENT_VERSION=$(yq -r .version Chart.yaml)
          echo "Current version: $CURRENT_VERSION"

          # Parse version
          IFS='.' read -r -a version_parts <<< "$CURRENT_VERSION"
          MAJOR="${version_parts[0]}"
          MINOR="${version_parts[1]}"
          PATCH="${version_parts[2]}"

          # Increment based on input
          case "${{ github.event.inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update Chart.yaml version
          sed -i "s/^version: .*/version: $NEW_VERSION/" Chart.yaml

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: update crucible umbrella chart to ${{ steps.version.outputs.new_version }}
          branch: crucible-umbrella-${{ steps.version.outputs.new_version }}
          delete-branch: true
          title: "Crucible Umbrella to ${{ steps.version.outputs.new_version }}"
          body: |
            Automated update of Crucible umbrella chart to version ${{ steps.version.outputs.new_version }}.

            - Updated all CMU SEI chart dependencies to latest versions
            - Bumped umbrella chart version (${{ github.event.inputs.version_bump }} bump)
            - Regenerated Chart.lock file
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>

      - name: No changes needed
        if: steps.update.outputs.has_changes == 'false'
        run: |
          echo "All charts are already up to date. No PR created."
