{{- /* Get postgres password from crucible-infra secret */ -}}
{{- $postgresConfig := .Values.global.postgresql | default dict -}}
{{- if not $postgresConfig }}
{{- $postgresConfig = .Values.postgresql | default dict -}}
{{- end }}
{{- $postgresPort := default 5432 (index $postgresConfig "port") -}}
{{- $postgresUser := default "postgres" (index $postgresConfig "user") -}}
{{- $postgresSecretKey := default "postgres-password" (index $postgresConfig "secretKey") -}}
{{- $postgresPassword := "" }}
{{- $postgresqlSecret := lookup "v1" "Secret" .Release.Namespace (include "crucible.postgresql.secretName" .) }}
{{- if $postgresqlSecret }}
{{-   $postgresPassword = index $postgresqlSecret.data $postgresSecretKey | b64dec }}
{{- else }}
{{-   $postgresPassword = randAlphaNum 16 }}
{{- end }}

{{- /* Persist Keycloak secrets on chart reinstall */ -}}
{{- $keycloakSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-keycloak-auth" (include "crucible.fullname" .)) -}}
{{- $keycloakAdminPassword := randAlphaNum 16 -}}
{{- $keycloakOauthClientSecret := (randBytes 16 | b64dec | printf "%032x") -}}
{{- $keycloakDefaultUserGuid := uuidv4 -}}

{{- if and $keycloakSecret (hasKey $keycloakSecret.data "admin-password") -}}
  {{- $keycloakAdminPassword = (index $keycloakSecret.data "admin-password" | b64dec) -}}
{{- end }}
{{- if and $keycloakSecret (hasKey $keycloakSecret.data "oauth-client-secret") -}}
  {{- $keycloakOauthClientSecret = (index $keycloakSecret.data "oauth-client-secret" | b64dec) -}}
{{- end }}
{{- if and $keycloakSecret (hasKey $keycloakSecret.data "default-user-guid") -}}
  {{- $keycloakDefaultUserGuid = (index $keycloakSecret.data "default-user-guid" | b64dec) -}}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" . }}-keycloak-auth
  labels:
    {{- include "crucible.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
stringData:
  admin-password: {{ $keycloakAdminPassword }}
  oauth-client-secret: {{ $keycloakOauthClientSecret }}
  default-user-guid: {{ $keycloakDefaultUserGuid }}

---
{{- /* Alloy API Secret */ -}}
{{- $alloyValues := default dict (index $.Values "crucible-alloy") -}}
{{- $alloyApiValues := default dict (index $alloyValues "alloy-api") -}}
{{- $resourceOwnerAuthorization := default dict (index $alloyApiValues "resourceOwnerAuthorization") -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-alloy-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=alloy;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;
  ResourceOwnerAuthorization__Authority: {{ tpl (default "" (index $resourceOwnerAuthorization "authority")) $ | quote }}
  ResourceOwnerAuthorization__ClientId: {{ tpl (default "" (index $resourceOwnerAuthorization "clientId")) $ | quote }}
  ResourceOwnerAuthorization__ClientSecret: {{ tpl (default "" (index $resourceOwnerAuthorization "clientSecret")) $ | quote }}
  ResourceOwnerAuthorization__UserName: {{ tpl (default "" (index $resourceOwnerAuthorization "userName")) $ | quote }}
  ResourceOwnerAuthorization__Password: {{ tpl (default "" (index $resourceOwnerAuthorization "password")) $ | quote }}

---
{{- /* TopoMojo API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-topomojo-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  appsettings.conf: |
    Database__ConnectionString = Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=topomojo;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;

---
{{- /* Player API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-player-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=player;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;

---
{{- /* VM API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-vm-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=player_vm;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;
  VmUsageLogging__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=player_vm_logging;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;

---
{{- /* Blueprint API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-blueprint-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=blueprint;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;
  ResourceOwnerAuthorization__Password: {{ $keycloakOauthClientSecret }}

---
{{- /* CITE API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-cite-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=cite;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;

---
{{- /* Gallery API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-gallery-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=gallery;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;

---
{{- /* Gameboard API Secret */ -}}
{{- $gameboardValues := default dict (index $.Values "gameboard") -}}
{{- $gameboardApiValues := default dict (index $gameboardValues "gameboard-api") -}}
{{- $gameEngineClientSecret := default "" (index $gameboardApiValues "gameEngineClientSecret") -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-gameboard-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  Database__ConnectionString: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=gameboard;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;
  GameEngine__ClientSecret: {{ tpl $gameEngineClientSecret $ | quote }}

---
{{- /* Caster API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-caster-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=caster;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;
  Client__Password: {{ $keycloakOauthClientSecret }}

---
{{- /* Steamfitter API Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible.fullname" $ }}-steamfitter-api-custom
  labels:
    {{- include "crucible.labels" $ | nindent 4 }}
type: Opaque
stringData:
  ConnectionStrings__PostgreSQL: Server={{ include "crucible.postgresql.serviceName" $ }};Port={{ $postgresPort }};Database=steamfitter;Username={{ $postgresUser }};Password={{ $postgresPassword }};SSL Mode=Prefer;Trust Server Certificate=true;
  ResourceOwnerAuthorization__Password: {{ $keycloakOauthClientSecret }}
