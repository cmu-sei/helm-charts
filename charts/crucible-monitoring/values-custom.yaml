# Crucible Monitoring Chart Values (Custom)
# This is a sample configuration based on the original deployment

global:
  domain: crucible
  namespace: default

# Prometheus for metrics collection
# https://artifacthub.io/packages/helm/prometheus-community/prometheus
prometheus:
  enabled: true
  server:
    extraArgs:
      # Enable remote-write receiver for Grafana Alloy
      web.enable-remote-write-receiver: ""
    persistentVolume:
      enabled: true
      size: 10Gi

# Grafana for dashboards and visualization
# https://artifacthub.io/packages/helm/grafana/grafana
grafana:
  enabled: true
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      nginx.ingress.kubernetes.io/configuration-snippet: |
        rewrite ^(/grafana)$ $1/ break;
    hosts:
      - "{{ .Values.global.domain }}"
    path: /grafana
    pathType: Prefix
    tls:
      - secretName: crucible-cert
        hosts:
          - "{{ .Values.global.domain }}"

  grafana.ini:
    server:
      root_url: https://{{ .Values.global.domain }}/grafana/
      serve_from_sub_path: true
    auth:
      disable_login_form: true
      signout_redirect_url: https://{{ .Values.global.domain }}/keycloak/realms/crucible/protocol/openid-connect/logout?redirect_uri=https://{{ .Values.global.domain }}/grafana/
    auth.generic_oauth:
      enabled: true
      name: Keycloak
      allow_sign_up: true
      client_id: grafana
      client_secret: ${GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET}
      scopes: openid profile email
      auth_url: https://{{ .Values.global.domain }}/keycloak/realms/crucible/protocol/openid-connect/auth
      token_url: https://{{ .Values.global.domain }}/keycloak/realms/crucible/protocol/openid-connect/token
      api_url: https://{{ .Values.global.domain }}/keycloak/realms/crucible/protocol/openid-connect/userinfo
      email_attribute_path: email
      login_attribute_path: email
      name_attribute_path: preferred_username
      role_attribute_path: "contains(realm_access.roles[*], 'Administrator') && 'Admin' || 'Viewer'"

  # Pre-configured datasources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          uid: prometheus
          type: prometheus
          url: http://{{ .Release.Name }}-prometheus-server
          isDefault: true
        - name: Loki
          uid: loki
          type: loki
          url: http://{{ .Release.Name }}-loki:3100
          jsonData:
            maxLines: 1000
        - name: Tempo
          uid: tempo
          type: tempo
          url: http://{{ .Release.Name }}-tempo:3100
          jsonData:
            httpMethod: GET
            tracesToMetrics:
              datasourceUid: prometheus
            serviceMap:
              datasourceUid: prometheus

  # Trust custom CA certificates
  env:
    SSL_CERT_FILE: /etc/ssl/certs/combined-ca/ca-certificates.crt
    GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET: 516aea1d6915825e2dd757834a34386bd21c942c6c42e7cbc52ef2ba7cfb5518

  extraInitContainers:
    - name: grafana-ca-bundle
      image: alpine:3.19
      command:
        - /bin/sh
        - -c
        - |
          set -e
          cp /etc/ssl/certs/ca-certificates.crt /ca-bundle/ca-certificates.crt
          cat /crucible-ca/crucible-dev.crt >> /ca-bundle/ca-certificates.crt
          if [ -f /crucible-ca/zscaler-ca.crt ]; then cat /crucible-ca/zscaler-ca.crt >> /ca-bundle/ca-certificates.crt; fi
      volumeMounts:
        - name: ca-bundle
          mountPath: /ca-bundle
        - name: crucible-ca
          mountPath: /crucible-ca

  extraVolumes:
    - name: crucible-ca
      configMap:
        name: crucible-ca-cert
        items:
          - key: crucible-dev.crt
            path: crucible-dev.crt
          - key: zscaler-ca.crt
            path: zscaler-ca.crt
    - name: ca-bundle
      emptyDir: {}

  extraVolumeMounts:
    - name: crucible-ca
      mountPath: /crucible-ca/crucible-dev.crt
      subPath: crucible-dev.crt
      readOnly: true
    - name: ca-bundle
      mountPath: /etc/ssl/certs/combined-ca
      readOnly: true

# Loki for log aggregation
# https://artifacthub.io/packages/helm/grafana/loki
loki:
  enabled: true
  deploymentMode: SingleBinary
  gateway:
    enabled: false
  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      size: 10Gi
    # Trust custom CA certificates
    extraEnv:
      - name: SSL_CERT_FILE
        value: /usr/local/share/ca-certificates/crucible-dev.crt
    extraVolumes:
      - name: crucible-ca
        configMap:
          name: crucible-ca-cert
          items:
            - key: crucible-dev.crt
              path: crucible-dev.crt
    extraVolumeMounts:
      - name: crucible-ca
        mountPath: /usr/local/share/ca-certificates/crucible-dev.crt
        subPath: crucible-dev.crt
        readOnly: true
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0
  loki:
    auth_enabled: false
    storage:
      type: filesystem
      filesystem:
        chunks_directory: /var/loki/chunks
        rules_directory: /var/loki/rules
    commonConfig:
      replication_factor: 1
    useTestSchema: true

# Tempo for distributed tracing
# https://artifacthub.io/packages/helm/grafana/tempo
tempo:
  enabled: true
  replicas: 1
  tempo:
    storage:
      trace:
        backend: local
        local:
          path: /var/tempo/traces
        wal:
          path: /var/tempo/wal
    # OTLP receivers for traces
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: "0.0.0.0:4317"
          http:
            endpoint: "0.0.0.0:4318"
  persistence:
    enabled: true
    size: 10Gi
  tempoQuery:
    enabled: false

# Grafana Alloy - OpenTelemetry Collector
# https://artifacthub.io/packages/helm/grafana/alloy
grafana-alloy:
  # Disabled by default - enable for automatic log/metric/trace collection
  enabled: false
  fullnameOverride: "crucible-grafana-alloy"
  controller:
    type: daemonset
    volumes:
      extra:
        - name: crucible-ca
          configMap:
            name: crucible-ca-cert
            items:
              - key: crucible-dev.crt
                path: crucible-dev.crt
  alloy:
    stabilityLevel: experimental
    extraEnv:
      - name: SSL_CERT_FILE
        value: /usr/local/share/ca-certificates/crucible-dev.crt
    mounts:
      varlog: true
      dockercontainers: true
      extra:
        - name: crucible-ca
          mountPath: /usr/local/share/ca-certificates/crucible-dev.crt
          subPath: crucible-dev.crt
          readOnly: true
    # OTLP receiver ports
    extraPorts:
      - name: otlp-grpc
        port: 4317
        targetPort: 4317
        protocol: TCP
      - name: otlp-http
        port: 4318
        targetPort: 4318
        protocol: TCP
    configMap:
      # Full Alloy configuration for LGTM stack integration
      content: |-
        logging {
          level = "info"
        }

        // Kubernetes pod discovery
        discovery.kubernetes "pods" {
          role = "pod"
        }

        // Relabel discovered pods
        discovery.relabel "pod_logs" {
          targets = discovery.kubernetes.pods.targets

          rule {
            source_labels = ["__meta_kubernetes_namespace"]
            action        = "replace"
            target_label  = "namespace"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_name"]
            action        = "replace"
            target_label  = "pod"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_container_name"]
            action        = "replace"
            target_label  = "container"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
            action        = "replace"
            target_label  = "app"
          }

          rule {
            source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_container_name"]
            action        = "replace"
            target_label  = "job"
            separator     = "/"
            replacement   = "$1"
          }
        }

        // Loki configuration
        loki.source.kubernetes "pods" {
          targets    = discovery.relabel.pod_logs.output
          forward_to = [loki.process.pods.receiver]
        }

        loki.process "pods" {
          stage.docker {}
          forward_to = [loki.write.default.receiver]
        }

        loki.write "default" {
          endpoint {
            url = "http://{{ .Release.Name }}-loki:3100/loki/api/v1/push"
          }
        }

        // Prometheus configuration
        prometheus.remote_write "default" {
          endpoint {
            url = "http://{{ .Release.Name }}-prometheus-server/api/v1/write"
          }
        }

        prometheus.scrape "pods" {
          targets    = discovery.kubernetes.pods.targets
          forward_to = [prometheus.remote_write.default.receiver]
        }

        // OpenTelemetry exporters
        otelcol.exporter.loki "default" {
          forward_to = [loki.write.default.receiver]
        }

        otelcol.exporter.otlp "default" {
          client {
            endpoint = "{{ .Release.Name }}-tempo:4317"
            tls {
              insecure = true
            }
          }
        }

        otelcol.exporter.prometheus "default" {
          forward_to = [prometheus.remote_write.default.receiver]
        }

        // Batch processor
        otelcol.processor.batch "default" {
          output {
            metrics = [otelcol.exporter.prometheus.default.input]
            logs    = [otelcol.exporter.loki.default.input]
            traces  = [otelcol.exporter.otlp.default.input]
          }
        }

        // OTLP receiver
        otelcol.receiver.otlp "default" {
          grpc {
            endpoint = "0.0.0.0:4317"
          }

          http {
            endpoint = "0.0.0.0:4318"
          }

          output {
            metrics = [otelcol.processor.batch.default.input]
            logs    = [otelcol.processor.batch.default.input]
            traces  = [otelcol.processor.batch.default.input]
          }
        }
