{{- if .Values.giturl }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mkdocs-material.fullname" . }}-entry
  labels:
    {{- include "mkdocs-material.labels" . | nindent 4 }}

data:
  git-pull.sh: |-
    #!/bin/sh

    {{- if .Values.cacert }}
    # update CA trust
    cat << EOF > /usr/local/share/ca-certificates/cacert.crt
    {{ .Values.cacert | indent 4 | trim }}
    EOF
    update-ca-certificates
    {{- end }}

    giturl={{ .Values.giturl }}
    branch={{ .Values.gitbranch }}

    {{- if .Values.gitCredentialsSecret }}
    git config --global credential.helper "store --file=/git-credentials/{{ .Values.gitCredentialsSecretKey | default ".git-credentials" }}"
    {{- end }}

    ## pull updates (and clone on first attempt)
    cd /docs
    if [ ! -d .git ]; then
      rm -rf *
      git clone $giturl .
    fi
    if [ -n "$branch" ]; then
      git checkout $branch
    fi
    git pull
    git reset --hard

    {{- if .Values.mkdocs.site_url }}
    sed -i -r -e 's#^(site_url: )(.*)#\1{{ .Values.mkdocs.site_url }}#' mkdocs.yml
    found_url=`grep -c 'site_url:' mkdocs.yml`
    if [ $found_url = 0 ]; then 
      echo 'site_url: {{ .Values.mkdocs.site_url }}' | cat - mkdocs.yml > tmp.yml
      mv tmp.yml mkdocs.yml
    fi
    {{ end }}

{{- end }}
