{{- /* Persist postgres account password on chart reinstall */ -}}
{{- $postgresPassword := "" }}
{{- $postgresqlSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-postgresql" (include "crucible-infra.fullname" .)) }}
{{- if $postgresqlSecret }}
{{-   $postgresPassword = index $postgresqlSecret.data "postgres-password" | b64dec }}
{{- else }}
{{-   $postgresPassword = randAlphaNum 16 }}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible-infra.fullname" . }}-postgresql
  labels:
    {{- include "crucible-infra.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
data:
  postgres-password: {{ $postgresPassword | b64enc | quote }}

---
{{- /* Persist pgAdmin password on chart reinstall */ -}}
{{- $pgadminPassword := "" }}
{{- $pgadminSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-pgadmin" (include "crucible-infra.fullname" .)) }}
{{- if $pgadminSecret }}
{{-   $pgadminPassword = index $pgadminSecret.data "password" | b64dec }}
{{- else }}
{{-   $pgadminPassword = randAlphaNum 16 }}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "crucible-infra.fullname" . }}-pgadmin
  labels:
    {{- include "crucible-infra.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
data:
  password: {{ $pgadminPassword | b64enc | quote }}

---
{{- /* TLS Certificate Secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: crucible-cert
  labels:
    {{- include "crucible-infra.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: kubernetes.io/tls
data:
  tls.crt: {{ (.Files.Get "files/crucible-dev.crt" | b64enc) | quote }}
  tls.key: {{ (.Files.Get "files/crucible-dev.key" | b64enc) | quote }}
